<!DOCTYPE html>
<!--
    Copyright (c) ivonne . All rights reserved.

-->
<html>
  <head>
    <title>Geolocalización </title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" charset="utf-8">
		
	// Options: throw an error if no update is received every 30 seconds.
	//var watchID = navigator.geolocation.watchPosition(onSuccess, onError, {maximumAge: 60000, timeout: 5000, enableHighAccuracy: true }); // esta me mira cada momento
	var watchID = navigator.geolocation.getCurrentPosition(onSuccess, onError, {maximumAge: 30000, timeout: 5000, enableHighAccuracy: true }); // esta me mira una vez
	//var watchID = navigator.geolocation.watchPosition(onSuccess, onError, 500000);
	
	function onSuccess(position) {
		var element = document.getElementById('geolocation');
		initialize(position.coords.latitude,position.coords.longitude);
	    return position;
	}
	function initialize(lat,log) {
			/*
				Basado en un código en
				https://developers.google.com/maps/documentation/javascript/geocoding?hl=es#GeocodingResponses
			*/
				var geocoder;
				var map;
				var infowindow = new google.maps.InfoWindow();	
				var element = document.getElementById('resultado');
				var latlng = new google.maps.LatLng(lat,log);
				var mapOptions = {
					zoom: 15,
					center: latlng,
					mapTypeId: 'roadmap'
				}
			 
				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
				
				var marker = new google.maps.Marker({
								position: latlng,
								map: map,
								title: 'Hello World!'
							  });
							  
				geocoder = new google.maps.Geocoder();
				geocoder.geocode({"latLng": latlng}, function(results, status)
			{
				
				if (status == google.maps.GeocoderStatus.OK)
				{
					if (results[0]) 
					{ //alert(JSON.stringify(results.length));
						/*for(var i=0;i<results.length;i++){
							//Creamos una nueva latlng para situar un punto en el mapa
							
							var marker = new google.maps.Marker({
								position:results[i].geometry.location, 
								map: map,
								title: 'Punto numero '+i
							  });
						}*/
						/*alert(JSON.stringify(results[i]));return;*/
						
						dir = "<p><strong>Dirección: </strong>" + results[0].formatted_address + "</p>";
						dir += '<p><strong>address_components.short_name:</strong>'+results[0].address_components[0]['short_name']+'</p>';
						dir += '<p><strong>address_components.short_name:</strong>'+results[0].address_components[0]['long_name']+'</p>';
						dir += '<p><strong>place id:</strong>'+results[0].place_id+'</p>';
						
						dir += '<span id="lat" class="hidden">'+lat+'</span>';
						dir += '<span id="log" class="hidden">'+log+'</span>';
						/*Por ahora son las que  he podido sacar de variables que se supone que son todas estass
						results[]: {
							 types[]: string,
							 formatted_address: string,
							 address_components[]: {
							   short_name: string,
							   long_name: string,
							   postcode_localities[]: string,
							   types[]: string
							 },
							 partial_match: boolean,
							 place_id: string,
							 postcode_localities[]: string,
							 geometry: {
							   location: LatLng,
							   location_type: GeocoderLocationType
							   viewport: LatLngBounds,
							   bounds: LatLngBounds
							 }
							}
						*/
					
					}
					else
					{
						dir = "<p>No se ha podido obtener ninguna dirección en esas coordenadas.</p>";
					}
				}
				else
				{
					dir = "<p>El Servicio de Codificación Geográfica ha fallado con el siguiente error: " + status + ".</p>";
				}

				element.innerHTML = dir;
				
			});

			  
			}
	function guardar_ubicacion(){
			var xhttp = new XMLHttpRequest();
			navigator.geolocation.getCurrentPosition(onSuccess, onError, {maximumAge: 30000, timeout: 5000, enableHighAccuracy: true });
			var element = document.getElementById('resultado_coordenadas');			
			  /*lo que se supone que voy a enviar*/
			   var lat = document.getElementById('lat').innerText;
			   var log = document.getElementById('log').innerText;
			   var lo_que_se_envia = ""
        	   lo_que_se_envia = '<p>LATITUD AHORA:' + lat + '</p>'
        	   lo_que_se_envia += '<p>Longitud AHORA:' + log + '</p>'
			   element.innerHTML = lo_que_se_envia  ;

			  /*
			  xhttp.open("GET", "demo_get.asp", true);
			  xhttp.send();
			  */
			  
	
	}

	function onError(error) {
		alert('code: '    + error.code    + '\n' +
			  'message: ' + error.message + '\n');
	}
	 function clearWatch() { 
		var watchID = navigator.geolocation.getCurrentPosition(onSuccess, onError, {maximumAge: 30000, timeout: 5000, enableHighAccuracy: true }); 
        if (watchID != null) {
            navigator.geolocation.clearWatch(watchID);
            watchID = null;
        }
		
		
    }

    </script>
	<style>
	 #map-canvas{
	   height:200px;
	   
	 }
	 .hidden{
	 display:none;
	 }
	</style>
  </head>
  <body>
   
    <p id="resultado"></p>
	  <button onclick="clearWatch();">Volver a ubicar</button>
	      <div id="map-canvas">
                                        
          </div>
	 <button onclick="guardar_ubicacion();">Guardar ubicacion</button>
	 <p id="resultado_coordenadas"></p>
<script>

    
    

</script>
  </body>
</html>


